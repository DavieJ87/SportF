<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
</head>
<body>
    <h1>User Profile</h1>
    <div id="user-info"></div>
    <div id="user-email"></div>

    <h2>Last 5 Predictions</h2>
    <ul id="last-predictions">
        <!-- Last 5 predictions will be dynamically populated -->
    </ul>

    <button id="sign-out-btn">Sign Out</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // Firebase configuration and initialization
        const firebaseConfig = {
            apiKey: "AIzaSyDaQnfeZFAFy8FNv1OiTisa50Vao9kT3OI",
            authDomain: "sportf-8c772.firebaseapp.com",
            databaseURL: "https://sportf-8c772-default-rtdb.firebaseio.com",
            projectId: "sportf-8c772",
            storageBucket: "sportf-8c772.appspot.com",
            messagingSenderId: "523775447476",
            appId: "1:523775447476:web:0f7a1a95fdc8fe7e02a2e1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        const userInfo = document.getElementById('user-info');
        const userEmail = document.getElementById('user-email');
        const lastPredictions = document.getElementById('last-predictions');
        const signOutBtn = document.getElementById('sign-out-btn');

        // Handle Sign-Out
        signOutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error during sign-out:', error);
            });
        });

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userInfo.textContent = `Hello, ${user.displayName}`;
                userEmail.textContent = `Email: ${user.email}`;
                fetchLastPredictions(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Function to fetch and display the last 5 predictions
        function fetchLastPredictions(userId) {
            const predictionsRef = ref(database, `predictions/${userId}`);
            onValue(predictionsRef, (snapshot) => {
                const predictions = snapshot.val();
                const predictionKeys = Object.keys(predictions || {}).slice(-5).reverse();

                lastPredictions.innerHTML = ''; // Clear previous predictions

                predictionKeys.forEach(key => {
                    const prediction = predictions[key];
                    const predictionItem = document.createElement('li');
                    predictionItem.textContent = `Match: ${key}, Predicted: ${prediction.predicted_home_score} - ${prediction.predicted_away_score}, Outcome: ${prediction.predicted_outcome}`;
                    lastPredictions.appendChild(predictionItem);
                });
            });
        }

        function fetchAndDisplayUserRank() {
    const user = auth.currentUser;
    if (!user) return;

    const userId = user.uid;
    const usersRef = ref(database, 'users');
    const userRanking = document.getElementById('user-ranking');

    get(usersRef).then((snapshot) => {
        if (snapshot.exists()) {
            const usersData = snapshot.val();
            const usersArray = [];

            for (let userId in usersData) {
                const userData = usersData[userId];
                usersArray.push({
                    userId: userId,
                    displayName: userData.displayName,
                    totalPoints: userData.total_points || 0
                });
            }

            // Sort users by total points in descending order
            usersArray.sort((a, b) => b.totalPoints - a.totalPoints);

            // Find the current user's rank
            const userRank = usersArray.findIndex(user => user.userId === userId) + 1;
            const totalPoints = usersData[userId].total_points || 0;

            userRanking.textContent = `Your Rank: ${userRank}, Total Points: ${totalPoints}`;
        }
    }).catch((error) => {
        console.error('Error fetching user rank:', error);
    });
}

// Call this function on profile.html page load
fetchAndDisplayUserRank();

    </script>
</body>
</html>
